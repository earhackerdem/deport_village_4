# Phase 3: Validation

Two-layer validation protocol to ensure correctness.

## Overview

After implementation, we validate in TWO layers:

1. **Layer 1: Fixture Validation** - Verify test data generation
2. **Layer 2: End-to-End Validation** - Verify API operations

**Both layers are MANDATORY**

## Why Two Layers?

### Layer 1 Purpose
Isolates factory/seeder issues from API issues.
If Layer 1 fails, problem is in data generation, not API logic.

### Layer 2 Purpose
Validates full stack integration (routes → controller → database).
Confirms real-world usage scenarios work correctly.

**Never skip either layer!**

## Prerequisites

✅ Phase 2 completed
✅ All tests passing
✅ Test coverage >80%
✅ Migrations defined
✅ Seeders created

---

## Layer 1: Fixture Validation

### Purpose
Verify that factories and seeders generate data correctly.

### Step 1: Prepare Database
```bash
make shell

php artisan migrate:fresh

php artisan migrate
```

### Step 2: Run Seeders
```bash
php artisan db:seed --class=TaskSeeder

php artisan db:seed
```

**Expected Output:**
```
Seeding: Database\Seeders\TaskSeeder
Seeded:  Database\Seeders\TaskSeeder (XX.XXms)
```

### Step 3: Access Database
```bash
exit

make sql
```

### Step 4: Execute Verification Queries

See: `docs/quick-reference/mysql-queries.md` for complete templates

#### Query 1: Count Records
```sql
SELECT COUNT(*) FROM tasks;
```

**Expected:** 20 (or number specified in seeder)

✅ Passes if count matches
❌ Fails if count is 0 or different

#### Query 2: Verify Table Structure
```sql
DESCRIBE tasks;
```

**Expected Output:**
```
+-------------+-----------------+------+-----+---------+----------------+
| Field       | Type            | Null | Key | Default | Extra          |
+-------------+-----------------+------+-----+---------+----------------+
| id          | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| title       | varchar(255)    | NO   |     | NULL    |                |
| description | text            | YES  |     | NULL    |                |
| status      | varchar(255)    | NO   |     | pendiente |              |
| created_at  | timestamp       | YES  |     | NULL    |                |
| updated_at  | timestamp       | YES  |     | NULL    |                |
+-------------+-----------------+------+-----+---------+----------------+
```

**Verify:**
✅ All expected columns present
✅ Correct data types
✅ Nullable constraints match migration
✅ Default values configured

#### Query 3: Sample Data
```sql
SELECT * FROM tasks LIMIT 5;
```

**Verify:**
✅ All fields populated (except nullable ones)
✅ Data looks realistic (thanks to Faker)
✅ IDs are sequential
✅ Timestamps are present
✅ Status values are valid

#### Query 4: Status Distribution
```sql
SELECT status, COUNT(*) as count 
FROM tasks 
GROUP BY status;
```

**Expected Output:**
```
+---------------+-------+
| status        | count |
+---------------+-------+
| pendiente     |     7 |
| en progreso   |     6 |
| completada    |     7 |
+---------------+-------+
```

**Verify:**
✅ All status values are valid
✅ Distribution is relatively even (randomElement working)
✅ No invalid/null status values

#### Query 5: Check Constraints
```sql
SELECT COUNT(*) FROM tasks WHERE title IS NULL;

SELECT COUNT(*) FROM tasks 
WHERE status NOT IN ('pendiente', 'en progreso', 'completada');
```

**Expected:** Both should return 0

### Layer 1 Success Criteria

✅ Correct number of records created
✅ All fields match migration definition
✅ Realistic data generated by Faker
✅ No constraint violations
✅ No null values in required fields
✅ Valid enum values only
✅ Timestamps populated

### If Layer 1 Fails

**Problem in Factory:**
- Check Faker methods match field types
- Verify randomElement values match validation rules
- Ensure nullable fields handled correctly

**Problem in Seeder:**
- Verify count() parameter
- Check if called from DatabaseSeeder
- Ensure factory is properly referenced

**Problem in Migration:**
- Check field definitions
- Verify nullable/default constraints
- Run migrate:fresh and try again

---

## Layer 2: End-to-End Validation

### Purpose
Validate full stack: HTTP request → routing → controller → database → response

### Step 1: Identify Endpoints to Test

Based on implementation, list all endpoints:
```
POST   /api/tasks       - Create task
GET    /api/tasks       - List tasks
GET    /api/tasks/{id}  - Show task
PUT    /api/tasks/{id}  - Update task
DELETE /api/tasks/{id}  - Delete task
```

### Step 2: Execute cURL Commands

See: `docs/quick-reference/curl-templates.md` for complete templates

#### Test 1: Create Task (POST)
```bash
exit

curl -X POST http://localhost/api/tasks \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "title": "Task from cURL",
    "description": "Testing API with cURL",
    "status": "pendiente"
  }'
```

**Expected Response:**
```json
{
  "id": 21,
  "title": "Task from cURL",
  "description": "Testing API with cURL",
  "status": "pendiente",
  "created_at": "2025-10-25T10:30:00.000000Z",
  "updated_at": "2025-10-25T10:30:00.000000Z"
}
```

**Verify Response:**
✅ Status: HTTP 201 Created
✅ JSON structure matches model
✅ ID is present (auto-generated)
✅ Timestamps are populated
✅ Data matches what was sent

#### Test 2: Verify in Database
```bash
make sql

SELECT * FROM tasks WHERE title = 'Task from cURL';
```

**Expected:**
```
+----+-----------------+-------------------------+-----------+---------------------+---------------------+
| id | title           | description             | status    | created_at          | updated_at          |
+----+-----------------+-------------------------+-----------+---------------------+---------------------+
| 21 | Task from cURL  | Testing API with cURL   | pendiente | 2025-10-25 10:30:00 | 2025-10-25 10:30:00 |
+----+-----------------+-------------------------+-----------+---------------------+---------------------+
```

**Verify:**
✅ Record exists in database
✅ All fields match request data
✅ ID matches response
✅ Timestamps match response

**Exit MySQL:**
```bash
exit
```

#### Test 3: List Tasks (GET)
```bash
curl http://localhost/api/tasks \
  -H "Accept: application/json"
```

**Expected Response:**
```json
[
  {
    "id": 1,
    "title": "First task from seeder",
    ...
  },
  ...
  {
    "id": 21,
    "title": "Task from cURL",
    ...
  }
]
```

**Verify:**
✅ Status: HTTP 200 OK
✅ Array of tasks returned
✅ Should have 21 tasks (20 from seeder + 1 from POST)
✅ Latest task (ID 21) is present

#### Test 4: Show Single Task (GET)
```bash
curl http://localhost/api/tasks/21 \
  -H "Accept: application/json"
```

**Expected Response:**
```json
{
  "id": 21,
  "title": "Task from cURL",
  "description": "Testing API with cURL",
  "status": "pendiente",
  "created_at": "2025-10-25T10:30:00.000000Z",
  "updated_at": "2025-10-25T10:30:00.000000Z"
}
```

**Verify:**
✅ Status: HTTP 200 OK
✅ Single task object returned
✅ Correct task (ID 21)
✅ All fields present

#### Test 5: Update Task (PUT)
```bash
curl -X PUT http://localhost/api/tasks/21 \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "title": "Updated Task",
    "description": "Updated description",
    "status": "en progreso"
  }'
```

**Expected Response:**
```json
{
  "id": 21,
  "title": "Updated Task",
  "description": "Updated description",
  "status": "en progreso",
  "created_at": "2025-10-25T10:30:00.000000Z",
  "updated_at": "2025-10-25T10:35:00.000000Z"
}
```

**Verify Response:**
✅ Status: HTTP 200 OK
✅ Title updated
✅ Description updated
✅ Status changed to "en progreso"
✅ updated_at timestamp changed
✅ created_at remains the same

**Verify in Database:**
```bash
make sql
SELECT * FROM tasks WHERE id = 21;
exit
```

**Expected:**
```
+----+--------------+---------------------+-------------+---------------------+---------------------+
| id | title        | description         | status      | created_at          | updated_at          |
+----+--------------+---------------------+-------------+---------------------+---------------------+
| 21 | Updated Task | Updated description | en progreso | 2025-10-25 10:30:00 | 2025-10-25 10:35:00 |
+----+--------------+---------------------+-------------+---------------------+---------------------+
```

✅ Database reflects changes

#### Test 6: Delete Task (DELETE)
```bash
curl -X DELETE http://localhost/api/tasks/21 \
  -H "Accept: application/json"
```

**Expected Response:**
- Status: HTTP 204 No Content
- Empty body (or null)

**Verify in Database:**
```bash
make sql
SELECT * FROM tasks WHERE id = 21;
```

**Expected:** Empty set (0 rows)

**Also verify count decreased:**
```sql
SELECT COUNT(*) FROM tasks;
```

**Expected:** 20 (back to seeder count)
```bash
exit
```

#### Test 7: Validation Errors (422)

Test that validation works:
```bash
curl -X POST http://localhost/api/tasks \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "description": "No title provided"
  }'
```

**Expected Response:**
```json
{
  "message": "The title field is required.",
  "errors": {
    "title": [
      "The title field is required."
    ]
  }
}
```

**Verify:**
✅ Status: HTTP 422 Unprocessable Entity
✅ Error message present
✅ Validation errors detailed
```bash
curl -X POST http://localhost/api/tasks \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "title": "Task with invalid status",
    "status": "invalid-status"
  }'
```

**Expected:**
✅ Status: HTTP 422
✅ Validation error for status field

### State Comparison

**Before E2E Tests:**
```sql
SELECT COUNT(*) FROM tasks;
```

**After E2E Tests:**
```sql
SELECT COUNT(*) FROM tasks;
```

**Verify:**
✅ Database state is as expected
✅ No orphaned records
✅ Constraints still enforced

---

## Layer 2 Success Criteria

✅ **POST endpoint:**
   - Returns 201 status
   - Creates record in database
   - Response matches created data
   - Validation catches invalid data (422)

✅ **GET endpoint (list):**
   - Returns 200 status
   - Returns all tasks
   - JSON array format

✅ **GET endpoint (show):**
   - Returns 200 status
   - Returns single task
   - Correct task by ID

✅ **PUT endpoint:**
   - Returns 200 status
   - Updates database record
   - Response shows updated data
   - updated_at timestamp changes

✅ **DELETE endpoint:**
   - Returns 204 status
   - Removes record from database
   - Count decreases by 1

✅ **Validation:**
   - Returns 422 for invalid data
   - Error messages are descriptive

---

## Common Issues and Solutions

### Issue: cURL returns 404

**Possible Causes:**
- Route not defined
- Wrong URL
- API prefix missing

**Solution:**
```bash
make shell
php artisan route:list | grep tasks

curl http://localhost/api/tasks
curl http://localhost/tasks
```

### Issue: cURL returns 500

**Possible Causes:**
- Code error in controller
- Missing use statement
- Database connection issue

**Solution:**
```bash
make shell
tail -f storage/logs/laravel.log

php artisan test
```

### Issue: Validation not working

**Possible Causes:**
- FormRequest not used in controller
- Rules defined incorrectly
- authorize() returns false

**Solution:**
```php
public function store(StoreTaskRequest $request)

public function rules(): array { ... }

public function authorize(): bool
{
    return true;
}
```

### Issue: Database not updating

**Possible Causes:**
- Fillable not configured
- Using wrong method (insert vs create)
- Not calling save()

**Solution:**
```php
protected $fillable = ['title', 'description', 'status'];

Task::create($request->validated());

$task = new Task();
$task->fill($request->validated());
$task->save();
```

---

## Validation Checklist

### Before Moving to Phase 4

**Layer 1 Complete:**
- [ ] Seeders run successfully
- [ ] Correct number of records created
- [ ] All fields populated correctly
- [ ] No constraint violations
- [ ] Data looks realistic

**Layer 2 Complete:**
- [ ] POST creates records (201)
- [ ] GET list returns all tasks (200)
- [ ] GET show returns single task (200)
- [ ] PUT updates records (200)
- [ ] DELETE removes records (204)
- [ ] Validation catches errors (422)
- [ ] Database state verified after each operation
- [ ] No orphaned or incorrect data

**Both Layers:**
- [ ] No manual intervention needed
- [ ] Results match expectations
- [ ] Edge cases tested
- [ ] Error handling works

---

## Documentation Requirements

When validation complete, document:

1. **Layer 1 Results:**
   - Number of records created
   - Query results screenshots/output
   - Any issues encountered and resolved

2. **Layer 2 Results:**
   - Each endpoint tested with cURL
   - Request and response for each
   - Database state before/after
   - Any issues encountered and resolved

**This documentation will be used in:**
- PR description
- Jira comment
- Team knowledge base

---

## After Validation Complete

Once both layers pass:

1. ✅ All fixtures validated
2. ✅ All endpoints tested with cURL
3. ✅ Database persistence confirmed
4. ✅ Results documented
5. ➡️ Move to [Phase 4: Integration](./phase-4-integration.md)

---

## Related Documentation

- [MySQL Query Templates](../quick-reference/mysql-queries.md)
- [cURL Templates](../quick-reference/curl-templates.md)
- [Troubleshooting Guide](../troubleshooting.md)

## Time Estimate

Phase 3 typically takes: **8-12 minutes**
- Layer 1 (Fixtures): 3-5 min
- Layer 2 (End-to-End): 5-7 min

